name: Reusable Auto-Rebase

on:
  workflow_call:
    inputs:
      taskmaster_api_url:
        description: 'TaskMaster API URL for AI escalation'
        required: false
        type: string
        default: 'https://taskmaster-platform.thankfulsand-8986c25c.eastus2.azurecontainerapps.io'
    secrets:
      TASKMASTER_API_KEY:
        required: false

jobs:
  auto-rebase:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get open PRs and rebase
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TASKMASTER_API_KEY: ${{ secrets.TASKMASTER_API_KEY }}
          TASKMASTER_API_URL: ${{ inputs.taskmaster_api_url }}
        run: |
          echo "Fetching open PRs..."
          prs=$(gh pr list --state open --json number,headRefName,title)
          
          if [ -z "$prs" ] || [ "$prs" == "[]" ]; then
            echo "No open PRs to rebase"
            exit 0
          fi
          
          echo "Found PRs:"
          echo "$prs" | jq -r '.[] | "  PR #\(.number): \(.headRefName)"'
          
          git fetch origin main
          git checkout main
          git pull origin main
          
          success_count=0
          conflict_count=0
          
          echo "$prs" | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            branch=$(echo "$pr" | jq -r '.headRefName')
            pr_title=$(echo "$pr" | jq -r '.title')
            
            echo ""
            echo "=========================================="
            echo "Processing PR #$pr_number: $branch"
            echo "=========================================="
            
            if ! git fetch origin "$branch" 2>/dev/null; then
              echo "Could not fetch branch $branch - skipping"
              continue
            fi
            
            git checkout -B "$branch" "origin/$branch"
            
            echo "Attempting rebase onto main..."
            if git rebase main 2>&1; then
              echo "Rebase successful for PR #$pr_number"
              if git push origin "$branch" --force-with-lease 2>&1; then
                echo "Pushed rebased branch $branch"
                success_count=$((success_count + 1))
              else
                echo "Could not push branch $branch"
                git rebase --abort 2>/dev/null || true
              fi
            else
              echo "Rebase failed for PR #$pr_number due to conflicts"
              conflicted_files=$(git diff --name-only --diff-filter=U 2>/dev/null | tr '\n' ', ' | sed 's/,$//')
              git rebase --abort
              
              gh pr comment "$pr_number" --body "⚠️ **Auto-Rebase Failed**

          Conflicts detected. Manual resolution required.

          **Conflicted Files:** $conflicted_files

          \`\`\`bash
          git fetch origin main
          git checkout $branch
          git rebase origin/main
          # Resolve conflicts
          git push origin $branch --force-with-lease
          \`\`\`"
              
              conflict_count=$((conflict_count + 1))
            fi
            
            git checkout main
          done
          
          echo ""
          echo "=========================================="
          echo "Summary: $success_count rebased, $conflict_count conflicts"
          echo "=========================================="
